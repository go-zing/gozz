<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How It Works | GOZZ</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/gozz/favicon.ico">
    <meta name="description" content="Golang Annotation Analyzer and Template-Programing Kits">
    <meta name="keywords" content="Golang,Golang Framework,Golang Tools,Golang Annotation,Golang DI,Dependency Inject,">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/gozz/assets/css/0.styles.7e6b5b93.css" as="style"><link rel="preload" href="/gozz/assets/js/app.7dc46aae.js" as="script"><link rel="preload" href="/gozz/assets/js/2.00c67221.js" as="script"><link rel="preload" href="/gozz/assets/js/1.a8abd916.js" as="script"><link rel="preload" href="/gozz/assets/js/29.9e50a0aa.js" as="script"><link rel="prefetch" href="/gozz/assets/js/10.cb77cb39.js"><link rel="prefetch" href="/gozz/assets/js/11.4eefee1e.js"><link rel="prefetch" href="/gozz/assets/js/12.7dc5e979.js"><link rel="prefetch" href="/gozz/assets/js/13.531016af.js"><link rel="prefetch" href="/gozz/assets/js/14.ec0583a2.js"><link rel="prefetch" href="/gozz/assets/js/15.90f29316.js"><link rel="prefetch" href="/gozz/assets/js/16.757bc54e.js"><link rel="prefetch" href="/gozz/assets/js/17.7a57509e.js"><link rel="prefetch" href="/gozz/assets/js/18.089ef4f8.js"><link rel="prefetch" href="/gozz/assets/js/19.640fd721.js"><link rel="prefetch" href="/gozz/assets/js/20.b142d34f.js"><link rel="prefetch" href="/gozz/assets/js/21.268d889b.js"><link rel="prefetch" href="/gozz/assets/js/22.530a35cb.js"><link rel="prefetch" href="/gozz/assets/js/23.3a5fd19e.js"><link rel="prefetch" href="/gozz/assets/js/24.3fc233a3.js"><link rel="prefetch" href="/gozz/assets/js/25.40efa5c5.js"><link rel="prefetch" href="/gozz/assets/js/26.2fa1abbd.js"><link rel="prefetch" href="/gozz/assets/js/27.9522f4f6.js"><link rel="prefetch" href="/gozz/assets/js/28.6935a49e.js"><link rel="prefetch" href="/gozz/assets/js/3.8162091f.js"><link rel="prefetch" href="/gozz/assets/js/30.3013f871.js"><link rel="prefetch" href="/gozz/assets/js/31.a1a29b49.js"><link rel="prefetch" href="/gozz/assets/js/32.e06e35b8.js"><link rel="prefetch" href="/gozz/assets/js/33.a5ef44d8.js"><link rel="prefetch" href="/gozz/assets/js/34.37628510.js"><link rel="prefetch" href="/gozz/assets/js/35.43f060f0.js"><link rel="prefetch" href="/gozz/assets/js/36.99e9608f.js"><link rel="prefetch" href="/gozz/assets/js/37.fe3096fc.js"><link rel="prefetch" href="/gozz/assets/js/38.335a5487.js"><link rel="prefetch" href="/gozz/assets/js/39.89246286.js"><link rel="prefetch" href="/gozz/assets/js/4.e3c555bd.js"><link rel="prefetch" href="/gozz/assets/js/40.53b85e42.js"><link rel="prefetch" href="/gozz/assets/js/41.dfd29db6.js"><link rel="prefetch" href="/gozz/assets/js/42.17490858.js"><link rel="prefetch" href="/gozz/assets/js/43.7ffa6b26.js"><link rel="prefetch" href="/gozz/assets/js/44.14fe2c83.js"><link rel="prefetch" href="/gozz/assets/js/45.92a5e7c8.js"><link rel="prefetch" href="/gozz/assets/js/46.211588c0.js"><link rel="prefetch" href="/gozz/assets/js/47.25fc96a8.js"><link rel="prefetch" href="/gozz/assets/js/48.4441bd7b.js"><link rel="prefetch" href="/gozz/assets/js/49.e1e2cdcc.js"><link rel="prefetch" href="/gozz/assets/js/5.24d53721.js"><link rel="prefetch" href="/gozz/assets/js/50.0ce9cdf8.js"><link rel="prefetch" href="/gozz/assets/js/6.50dc599a.js"><link rel="prefetch" href="/gozz/assets/js/7.cd44b1a2.js"><link rel="prefetch" href="/gozz/assets/js/vendors~docsearch.4dff5a50.js">
    <link rel="stylesheet" href="/gozz/assets/css/0.styles.7e6b5b93.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/gozz/" class="home-link router-link-active"><img src="/gozz/logo.png" alt="GOZZ" class="logo"> <span class="site-name can-hide">GOZZ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/gozz/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/gozz/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gozz/guide/how-it-works.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/gozz/zh/guide/how-it-works.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/go-zing/gozz" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/gozz/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/gozz/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gozz/guide/how-it-works.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/gozz/zh/guide/how-it-works.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/go-zing/gozz" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/gozz/guide/" aria-current="page" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gozz/guide/#vision" class="sidebar-link">Vision</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/#design-concept" class="sidebar-link">Design Concept</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/#applicable-scene" class="sidebar-link">Applicable scene</a></li></ul></li><li><a href="/gozz/guide/getting-started.html" class="sidebar-link">Get Started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gozz/guide/getting-started.html#usage" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/getting-started.html#cli" class="sidebar-link">CLI</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/getting-started.html#command" class="sidebar-link">Command</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/getting-started.html#annotation-syntax" class="sidebar-link">Annotation Syntax</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/getting-started.html#conventions" class="sidebar-link">Conventions</a></li></ul></li><li><a href="/gozz/guide/how-it-works.html" aria-current="page" class="active sidebar-link">How It Works</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gozz/guide/how-it-works.html#what-is-ast" class="sidebar-link">What is AST</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/how-it-works.html#golang-ast-in-short" class="sidebar-link">Golang AST in short</a></li><li class="sidebar-sub-header"><a href="/gozz/guide/how-it-works.html#annotations-analysis" class="sidebar-link">Annotations Analysis</a></li></ul></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/gozz/guide/plugins/" class="sidebar-heading clickable"><span>Builtin Plugins</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/gozz/guide/plugins/api.html" class="sidebar-link">Api</a></li><li><a href="/gozz/guide/plugins/doc.html" class="sidebar-link">Doc</a></li><li><a href="/gozz/guide/plugins/impl.html" class="sidebar-link">Impl</a></li><li><a href="/gozz/guide/plugins/option.html" class="sidebar-link">Option</a></li><li><a href="/gozz/guide/plugins/orm.html" class="sidebar-link">Orm</a></li><li><a href="/gozz/guide/plugins/tag.html" class="sidebar-link">Tag</a></li><li><a href="/gozz/guide/plugins/wire.html" class="sidebar-link">Wire</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How It Works</h1> <p>The main workflow of <code>Gozz</code> in short：</p> <p>Collects all rule match comments as annotations and setup context meta-info.
Plugins would use these entities to do extra analysis and do stuffs.</p> <p>To understand how these annotated objects were analyzed.
We should have knowledge about <code>Golang AST</code>.</p> <h2 id="what-is-ast"><a href="#what-is-ast" class="header-anchor">#</a> What is <code>AST</code></h2> <p><strong>Abstract Syntax Tree</strong>, it was a kind of structured presentation of codes.
Most of the programing languages would parse codes into <code>AST</code> object before execute or compile.
It is also a middle-state between Golang codes and executable binary.</p> <p>After parsed codes as <code>AST</code>, we could treat codes like a structured object, to walk nodes,
visit and detect node expression and do programing modify or analysis.
It would provide more flexibility than treat codes as text.</p> <p>Golang provide official syntax parser <code>go/ast</code> library,
so we can get <code>AST</code> as same as compiler,
also Golang provide <code>go/format</code> to convert <code>AST</code> into formatted text,
that bring great convenience for Golang toolkit ecosystem.</p> <p>Common tools used by gopher such as <code>gofmt</code> / <code>golangci-lint</code> was mainly based on <code>go/ast</code>.</p> <h2 id="golang-ast-in-short"><a href="#golang-ast-in-short" class="header-anchor">#</a> Golang AST in short</h2> <p>In <code>Golang AST</code>, we can consider most of the codes blocks below <code>package</code> as <code>Decl</code> (declaration).</p> <p><code>Decl</code> has two types: <code>GenDecl</code> (generic declaration) and <code>FuncDecl</code> (function declaration).</p> <p>Except for <code>func</code>, most of the declarations are <code>GenDecl</code>.</p> <p>Example:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> x

<span class="token comment">// GenDecl</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span> <span class="token string">&quot;go/ast&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">var</span> A <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	B  <span class="token operator">=</span> <span class="token number">2</span>
	B2 <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">type</span> C <span class="token builtin">int</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">type</span> <span class="token punctuation">(</span>
	D  <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	D2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">const</span> E <span class="token operator">=</span> <span class="token number">3</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	F  <span class="token operator">=</span> <span class="token number">4</span>
	F2 <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">)</span>

<span class="token comment">// FuncDecl</span>
<span class="token keyword">func</span> <span class="token function">G</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre></div><p>Codes object in <code>GenDecl</code> blocks would be called <code>Spec</code>,
with types <code>TypeSpec / ValueSpec / ImportSpec</code>.</p> <p><code>Spec</code> does not contains keywords token,
but type of <code>Spec</code> is decided by keywords ahead (<code>const/var/import/type</code>).</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> x

<span class="token comment">// GenDecl</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token comment">// ImportSpec</span>
	<span class="token boolean">_</span> <span class="token string">&quot;go/ast&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">var</span> A <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// ValueSpec</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token comment">// ValueSpec</span>
	B <span class="token operator">=</span> <span class="token number">2</span>
	<span class="token comment">// ValueSpec</span>
	B2 <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">type</span> C <span class="token builtin">int</span> <span class="token comment">// TypeSpec</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">type</span> <span class="token punctuation">(</span>
	<span class="token comment">// TypeSpec</span>
	D <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token comment">// TypeSpec</span>
	D2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">const</span> E <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">// ValueSpec</span>

<span class="token comment">// GenDecl</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	F  <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// ValueSpec</span>
	F2 <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// ValueSpec</span>
<span class="token punctuation">)</span>

</code></pre></div><p>Golang would relate comments to neighboring object, and according to their position,
comments could be divided into <code>Doc</code> or <code>Comment</code>.</p> <p><code>Doc</code> is comments on object, and <code>Comment</code> is comments behind object.</p> <p><code>Decl</code> objects only got <code>Doc</code>, while <code>Spec</code> objects have both <code>Doc</code> and <code>Comment</code>.</p> <p>You can check out the detect principle in <a href="/gozz/guide/plugins/doc.html#example-02">Doc Example 2</a></p> <p>Example:</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> x

<span class="token comment">// GenDeclDoc</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token comment">// ImportSpecDoc</span>
	<span class="token boolean">_</span> <span class="token string">&quot;go/ast&quot;</span> <span class="token comment">// ImportSpecComment</span>
<span class="token punctuation">)</span>

<span class="token comment">// GenDeclDoc</span>
<span class="token keyword">var</span> A <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// ValueSpecComment</span>

<span class="token comment">// GenDeclDoc</span>
<span class="token keyword">type</span> <span class="token punctuation">(</span>
	<span class="token comment">// TypeSpecDoc</span>
	B <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span> <span class="token comment">// TypeSpecComment</span>

	<span class="token comment">// TypeSpecDoc</span>
	B2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// FuncDeclDoc</span>
<span class="token keyword">func</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre></div><h2 id="annotations-analysis"><a href="#annotations-analysis" class="header-anchor">#</a> Annotations Analysis</h2> <h3 id="syntax-analysis"><a href="#syntax-analysis" class="header-anchor">#</a> Syntax Analysis</h3> <p>Before plugin execute, CLI core would parse files object comments and match comments from <code>AST</code>.
Comments would be split in lines and seperated into annotations or documents.</p> <p>All object with annotations would be collected as <code>AnnotationDecl</code>
( mainly <code>Spec</code> object except from <code>FuncDecl</code>).
And all these opened file info and parsed <code>AST</code> would be cached in memory.</p> <h3 id="annotations-parse"><a href="#annotations-parse" class="header-anchor">#</a> Annotations Parse</h3> <p>Before <code>AnnotationDecl</code> pass into plugin execution,
core would parse <code>AnnotationDecl</code>'s annotations with plugin name in lines.
<code>AnnotationDecl</code> may have several plugin-match annotations.</p> <p>Every matched annotations would be parsed into exact and optional arguments,
and merged with CLI command extend options.
At last combined with <code>AnnotationDecl</code> as <code>DeclEntity</code> object.</p> <p>The core method of every plugin is how to make use of these matched <code>DeclEntity</code>.</p> <h3 id="process-runtime"><a href="#process-runtime" class="header-anchor">#</a> Process Runtime</h3> <p>We could specify multi plugins in order in a command. Example:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>gozz run <span class="token parameter variable">-p</span> <span class="token string">&quot;api&quot;</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;impl&quot;</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;doc&quot;</span> <span class="token parameter variable">-p</span> <span class="token string">&quot;wire&quot;</span> ./
</code></pre></div><p><code>Gozz</code> would do analysis before every plugin execute,
because previous plugin may modify or generate files.</p> <p>But previous analysis would cache files and parsed results.
These caches may be reused only if file not modified.
Therefore, use multi plugins could get maximum reuse of parser cache,
and get better performance than split plugins in single run.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/go-zing/gozz-doc/edit/main/docs/guide/how-it-works.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/26/2023, 12:21:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/gozz/guide/getting-started.html" class="prev">
        Get Started
      </a></span> <span class="next"><a href="/gozz/guide/plugins/api.html">
        Api
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/gozz/assets/js/app.7dc46aae.js" defer></script><script src="/gozz/assets/js/2.00c67221.js" defer></script><script src="/gozz/assets/js/1.a8abd916.js" defer></script><script src="/gozz/assets/js/29.9e50a0aa.js" defer></script>
  </body>
</html>
